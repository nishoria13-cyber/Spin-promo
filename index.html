<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Spin & Win — One Spin Only</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;padding:20px;background:#fafafa;color:#111;display:flex;flex-direction:column;align-items:center;gap:18px}
  .wheel-wrap{position:relative;width:320px;height:320px;border-radius:50%;overflow:hidden;border:8px solid #333;background:white;box-shadow:0 6px 20px rgba(0,0,0,0.12)}
  #wheel{width:100%;height:100%;transform:rotate(0deg);transition:transform 5s cubic-bezier(.2,.8,.2,1)}
  .center{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:5}
  button{padding:12px 18px;font-size:16px;border-radius:8px;border:0;background:#0077ff;color:white;cursor:pointer}
  button[disabled]{opacity:0.5;cursor:not-allowed}
  .result{margin-top:12px;padding:12px;border-radius:8px;background:white;box-shadow:0 3px 10px rgba(0,0,0,0.06);min-width:260px;text-align:center}
  .coupon{font-weight:700;font-size:20px;margin-top:8px}
  .small{font-size:13px;color:#666;margin-top:6px}
</style>
</head>
<body>

<h1>Scan & Spin — Get 1 Discount</h1>

<div class="wheel-wrap" aria-hidden="true">
  <canvas id="wheel" width="320" height="320"></canvas>
  <div class="center">
    <button id="spinBtn">SPIN</button>
  </div>
</div>

<div id="message" class="result" aria-live="polite">
  <div id="status">You have <strong>1 spin</strong>. Good luck!</div>
  <div id="discount" style="display:none">
    <div class="small">You won:</div>
    <div id="wonPercent" style="font-size:28px;font-weight:700;margin-top:6px"></div>
    <div class="coupon" id="couponCode"></div>
    <div class="small">Show this code at checkout. Valid once.</div>
  </div>
</div>

<script>
/* CONFIG - edit these to change slices / frequencies */
const slices = [
  {text: '5%', weight: 25},
  {text: '10%', weight: 30},
  {text: '15%', weight: 20},
  {text: '20%', weight: 15},
  {text: '50%', weight: 5},
  {text: 'No prize', weight: 5}
];
const couponPrefix = 'PROMO'; // coupon prefix for codes
/* END CONFIG */

const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');
const size = canvas.width;
const cx = size/2;
const cy = size/2;
let angle = 0;

// prepare segments using weights to compute probabilities
const totalWeight = slices.reduce((s, it)=> s + it.weight, 0);
const segments = slices.map((s,i)=> {
  return { label: s.text, weight: s.weight, index:i };
});

function drawWheel(){
  const radius = size/2 - 2;
  let start = -Math.PI/2;
  for(let i=0;i<segments.length;i++){
    const seg = segments[i];
    const sliceAngle = (seg.weight/totalWeight) * Math.PI*2;
    const end = start + sliceAngle;
    // fill
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,radius,start,end);
    ctx.closePath();
    ctx.fillStyle = i % 2 ? '#fff' : '#f6f6f6';
    ctx.fill();
    ctx.strokeStyle = '#ddd';
    ctx.stroke();
    // label
    ctx.save();
    ctx.translate(cx,cy);
    const mid = start + sliceAngle/2;
    ctx.rotate(mid);
    ctx.textAlign = 'right';
    ctx.fillStyle = '#111';
    ctx.font = 'bold 14px sans-serif';
    ctx.fillText(seg.label, radius - 8, 6);
    ctx.restore();
    start = end;
  }
  // pointer
  ctx.fillStyle = '#d33';
  ctx.beginPath();
  ctx.moveTo(cx + radius + 6, cy);
  ctx.lineTo(cx + radius + 26, cy - 12);
  ctx.lineTo(cx + radius + 26, cy + 12);
  ctx.closePath();
  ctx.fill();
}
drawWheel();

/* utility: pick segment index using weighted random */
function weightedPickIndex(){
  const r = Math.random() * totalWeight;
  let acc = 0;
  for(let i=0;i<segments.length;i++){
    acc += segments[i].weight;
    if(r <= acc) return i;
  }
  return segments.length - 1;
}

const spinBtn = document.getElementById('spinBtn');
const status = document.getElementById('status');
const discountDiv = document.getElementById('discount');
const wonPercent = document.getElementById('wonPercent');
const couponCode = document.getElementById('couponCode');

const storageKey = 'promo_spin_done_v1';
if(localStorage.getItem(storageKey)){
  // already used
  spinBtn.disabled = true;
  status.innerHTML = 'You already used your spin. Thank you!';
}

spinBtn.addEventListener('click', () => {
  if(localStorage.getItem(storageKey)) return;
  spinBtn.disabled = true;
  status.innerHTML = 'Spinning...';
  // choose result
  const chosenIndex = weightedPickIndex();
  // compute final angle so pointer lands in chosen slice
  // compute cumulative start angle of chosen slice
  let startAngle = -Math.PI/2;
  for(let i=0;i<chosenIndex;i++){
    startAngle += (segments[i].weight/totalWeight) * Math.PI*2;
  }
  const sliceAngle = (segments[chosenIndex].weight/totalWeight) * Math.PI*2;
  // aim for middle of slice
  const targetMid = startAngle + sliceAngle/2;
  // convert to degrees and compute rotation
  const currentDeg = (angle * 180/Math.PI) % 360;
  const targetDeg = (targetMid * 180/Math.PI) * -1 + 360; // invert direction
  // add multiple turns for effect
  const extraTurns = 1440 + Math.floor(Math.random()*360); // 4 full turns (1440deg) + random
  const finalDeg = extraTurns + (targetDeg - currentDeg);
  angle = (finalDeg * Math.PI/180);
  // apply CSS transform on canvas as fallback (we used canvas drawing so rotate visually)
  canvas.style.transition = 'transform 4.8s cubic-bezier(.2,.8,.2,1)';
  canvas.style.transform = `rotate(${finalDeg}deg)`;
  // when animation ends, reveal prize
  setTimeout(() => {
    const label = segments[chosenIndex].label;
    status.innerHTML = 'Spin complete!';
    if(label.toLowerCase().includes('no prize')){
      wonPercent.innerText = label;
      couponCode.innerText = '';
    } else {
      wonPercent.innerText = label + ' off';
      // generate a coupon code (unique-ish)
      const rand = Math.random().toString(36).substr(2,6).toUpperCase();
      const code = couponPrefix + '-' + (label.replace(/[^0-9]/g,'')) + '-' + rand;
      couponCode.innerText = code;
    }
    discountDiv.style.display = 'block';
    // mark as used
    localStorage.setItem(storageKey, JSON.stringify({
      timestamp: Date.now(),
      result: label,
      coupon: couponCode.innerText || null
    }));
    // disable button permanently
    spinBtn.disabled = true;
  }, 5000);
});
</script>

</body>
</html>
